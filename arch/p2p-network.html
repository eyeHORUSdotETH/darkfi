<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The DarkFi Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">About</li><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> DarkFi</a></li><li class="chapter-item expanded "><a href="../philosophy/philosophy.html"><strong aria-hidden="true">2.</strong> Philosophy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../philosophy/ideology.html"><strong aria-hidden="true">2.1.</strong> Ideology</a></li><li class="chapter-item expanded "><a href="../philosophy/books.html"><strong aria-hidden="true">2.2.</strong> Books</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="../testnet/node.html"><strong aria-hidden="true">3.</strong> Running a Node</a></li><li class="chapter-item expanded "><a href="../testnet/airdrop.html"><strong aria-hidden="true">4.</strong> Airdrops</a></li><li class="chapter-item expanded "><a href="../testnet/payment.html"><strong aria-hidden="true">5.</strong> Payments</a></li><li class="chapter-item expanded "><a href="../testnet/atomic-swap.html"><strong aria-hidden="true">6.</strong> Atomic Swap</a></li><li class="chapter-item expanded "><a href="../testnet/dao.html"><strong aria-hidden="true">7.</strong> DAO</a></li><li class="chapter-item expanded "><a href="../misc/ircd/ircd.html"><strong aria-hidden="true">8.</strong> ircd</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/ircd/private_message.html"><strong aria-hidden="true">8.1.</strong> Private Message</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Developer Doc</li><li class="chapter-item expanded "><a href="../dev/development.html"><strong aria-hidden="true">9.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/contribute.html"><strong aria-hidden="true">9.1.</strong> Contribute</a></li><li class="chapter-item expanded "><a href="../dev/learn.html"><strong aria-hidden="true">9.2.</strong> Learn</a></li><li class="chapter-item expanded "><a href="../dev/rustdoc.html"><strong aria-hidden="true">9.3.</strong> API Rustdoc</a></li><li class="chapter-item expanded "><a href="../dev/seminars.html"><strong aria-hidden="true">9.4.</strong> Seminars</a></li></ol></li><li class="chapter-item expanded "><a href="../arch/arch.html"><strong aria-hidden="true">10.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/overview.html"><strong aria-hidden="true">10.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../arch/anonymous_assets.html"><strong aria-hidden="true">10.2.</strong> Anonymous assets</a></li><li class="chapter-item expanded "><a href="../arch/blockchain.html"><strong aria-hidden="true">10.3.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="../arch/consensus.html"><strong aria-hidden="true">10.4.</strong> Consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/consensus/genesis_stake.html"><strong aria-hidden="true">10.4.1.</strong> GenesisStake</a></li><li class="chapter-item expanded "><a href="../arch/consensus/stake.html"><strong aria-hidden="true">10.4.2.</strong> Stake</a></li><li class="chapter-item expanded "><a href="../arch/consensus/proposal.html"><strong aria-hidden="true">10.4.3.</strong> Proposal</a></li><li class="chapter-item expanded "><a href="../arch/consensus/unstake_request.html"><strong aria-hidden="true">10.4.4.</strong> UnstakeRequest</a></li><li class="chapter-item expanded "><a href="../arch/consensus/unstake.html"><strong aria-hidden="true">10.4.5.</strong> Unstake</a></li></ol></li><li class="chapter-item expanded "><a href="../arch/tx_lifetime.html"><strong aria-hidden="true">10.5.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../arch/smart_contracts.html"><strong aria-hidden="true">10.6.</strong> Smart Contracts</a></li><li class="chapter-item expanded "><a href="../arch/bridge.html"><strong aria-hidden="true">10.7.</strong> Bridge</a></li><li class="chapter-item expanded "><a href="../arch/tooling.html"><strong aria-hidden="true">10.8.</strong> Tooling</a></li><li class="chapter-item expanded "><a href="../arch/p2p-network.html" class="active"><strong aria-hidden="true">10.9.</strong> P2P Network</a></li><li class="chapter-item expanded "><a href="../arch/services.html"><strong aria-hidden="true">10.10.</strong> Services</a></li><li class="chapter-item expanded "><a href="../arch/sc/sc.html"><strong aria-hidden="true">10.11.</strong> Smart Contracts</a></li><li class="chapter-item expanded "><a href="../arch/sc/tx-lifetime.html"><strong aria-hidden="true">10.12.</strong> Transaction lifetime</a></li></ol></li><li class="chapter-item expanded "><a href="../zkas/index.html"><strong aria-hidden="true">11.</strong> zkas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/bincode.html"><strong aria-hidden="true">11.1.</strong> Bincode</a></li><li class="chapter-item expanded "><a href="../zkas/zkvm.html"><strong aria-hidden="true">11.2.</strong> zkVM</a></li><li class="chapter-item expanded "><a href="../zkas/examples.html"><strong aria-hidden="true">11.3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/examples/voting.html"><strong aria-hidden="true">11.3.1.</strong> Anonymous voting</a></li><li class="chapter-item expanded "><a href="../zkas/examples/sapling.html"><strong aria-hidden="true">11.3.2.</strong> Anonymous payments</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clients/clients.html"><strong aria-hidden="true">12.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clients/darkfid_jsonrpc.html"><strong aria-hidden="true">12.1.</strong> darkfid JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../clients/faucetd_jsonrpc.html"><strong aria-hidden="true">12.2.</strong> faucetd JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../clients/anonymous_nodes.html"><strong aria-hidden="true">12.3.</strong> Anonymous Nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clients/tor_inbound.html"><strong aria-hidden="true">12.3.1.</strong> Tor Inbound Node</a></li><li class="chapter-item expanded "><a href="../clients/nym_outbound.html"><strong aria-hidden="true">12.3.2.</strong> Nym Outbound Node</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Crypto</li><li class="chapter-item expanded "><a href="../crypto/fft.html"><strong aria-hidden="true">13.</strong> FFT</a></li><li class="chapter-item expanded "><a href="../crypto/zk_explainer.html"><strong aria-hidden="true">14.</strong> ZK explainer</a></li><li class="chapter-item expanded "><a href="../crypto/research.html"><strong aria-hidden="true">15.</strong> Research</a></li><li class="chapter-item expanded "><a href="../crypto/rln.html"><strong aria-hidden="true">16.</strong> Rate-Limit Nullifiers</a></li><li class="chapter-item expanded "><a href="../crypto/key-recovery.html"><strong aria-hidden="true">17.</strong> Key Recovery Scheme</a></li><li class="chapter-item expanded "><a href="../crypto/reading-maths-books.html"><strong aria-hidden="true">18.</strong> Reading maths books</a></li><li class="chapter-item expanded affix "><li class="part-title">DEP</li><li class="chapter-item expanded "><a href="../dep/0001.html"><strong aria-hidden="true">19.</strong> DEP 0001: Version Message Info</a></li><li class="chapter-item expanded affix "><li class="part-title">Specs</li><li class="chapter-item expanded "><a href="../spec/payment/payment.html"><strong aria-hidden="true">20.</strong> Payment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/payment/burn.html"><strong aria-hidden="true">20.1.</strong> burn</a></li><li class="chapter-item expanded "><a href="../spec/payment/mint.html"><strong aria-hidden="true">20.2.</strong> mint</a></li><li class="chapter-item expanded "><a href="../spec/payment/coin.html"><strong aria-hidden="true">20.3.</strong> coin</a></li><li class="chapter-item expanded "><a href="../spec/payment/token_id.html"><strong aria-hidden="true">20.4.</strong> token id</a></li><li class="chapter-item expanded "><a href="../spec/payment/freeze_token.html"><strong aria-hidden="true">20.5.</strong> freeze token</a></li><li class="chapter-item expanded "><a href="../spec/payment/token_mint.html"><strong aria-hidden="true">20.6.</strong> token mint</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/dao/index.html"><strong aria-hidden="true">21.</strong> Dao</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/dao/bulla.html"><strong aria-hidden="true">21.1.</strong> bulla</a></li><li class="chapter-item expanded "><a href="../spec/dao/proposal.html"><strong aria-hidden="true">21.2.</strong> proposal</a></li><li class="chapter-item expanded "><a href="../spec/dao/dao_propose.html"><strong aria-hidden="true">21.3.</strong> dao proposal</a></li><li class="chapter-item expanded "><a href="../spec/dao/dao_propose_burn.html"><strong aria-hidden="true">21.4.</strong> dao proposal burn</a></li><li class="chapter-item expanded "><a href="../spec/dao/mint.html"><strong aria-hidden="true">21.5.</strong> mint</a></li><li class="chapter-item expanded "><a href="../spec/dao/vote.html"><strong aria-hidden="true">21.6.</strong> vote</a></li><li class="chapter-item expanded "><a href="../spec/dao/vote_burn.html"><strong aria-hidden="true">21.7.</strong> vote burn</a></li><li class="chapter-item expanded "><a href="../spec/dao/dao_exec.html"><strong aria-hidden="true">21.8.</strong> exec</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/pos/index.html"><strong aria-hidden="true">22.</strong> Proof of Stake</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/pos/burn.html"><strong aria-hidden="true">22.1.</strong> burn</a></li><li class="chapter-item expanded "><a href="../spec/pos/mint.html"><strong aria-hidden="true">22.2.</strong> mint</a></li><li class="chapter-item expanded "><a href="../spec/pos/proposal.html"><strong aria-hidden="true">22.3.</strong> lottery</a></li></ol></li><li class="chapter-item expanded "><a href="../spec/crypto/index.html"><strong aria-hidden="true">23.</strong> Crypto</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spec/crypto/commitment.html"><strong aria-hidden="true">23.1.</strong> commitment</a></li><li class="chapter-item expanded "><a href="../spec/crypto/keypair.html"><strong aria-hidden="true">23.2.</strong> keypair</a></li><li class="chapter-item expanded "><a href="../spec/crypto/signature.html"><strong aria-hidden="true">23.3.</strong> Signature</a></li><li class="chapter-item expanded "><a href="../spec/crypto/hash.html"><strong aria-hidden="true">23.4.</strong> hash</a></li><li class="chapter-item expanded "><a href="../spec/crypto/merkletree.html"><strong aria-hidden="true">23.5.</strong> merkletree</a></li><li class="chapter-item expanded "><a href="../spec/crypto/note.html"><strong aria-hidden="true">23.6.</strong> note</a></li><li class="chapter-item expanded "><a href="../spec/crypto/vrf.html"><strong aria-hidden="true">23.7.</strong> vrf</a></li><li class="chapter-item expanded "><a href="../spec/crypto/nullifier.html"><strong aria-hidden="true">23.8.</strong> nullifier</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../misc/tor-darkirc.html"><strong aria-hidden="true">24.</strong> tor-darkirc</a></li><li class="chapter-item expanded "><a href="../misc/vanityaddr.html"><strong aria-hidden="true">25.</strong> vanityaddr</a></li><li class="chapter-item expanded "><a href="../misc/ircd/specification.html"><strong aria-hidden="true">26.</strong> IRCd Specification</a></li><li class="chapter-item expanded "><a href="../misc/tau.html"><strong aria-hidden="true">27.</strong> tau</a></li><li class="chapter-item expanded "><a href="../misc/event_graph/event_graph.html"><strong aria-hidden="true">28.</strong> event_graph</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/event_graph/network_protocol.html"><strong aria-hidden="true">28.1.</strong> Network Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../misc/dnetview.html"><strong aria-hidden="true">29.</strong> dnetview</a></li><li class="chapter-item expanded "><a href="../zero2darkfi/zero2darkfi.html"><strong aria-hidden="true">30.</strong> Zero2darkfi</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zero2darkfi/darkmap.html"><strong aria-hidden="true">30.1.</strong> darkmap</a></li></ol></li><li class="chapter-item expanded "><a href="../glossary/glossary.html"><strong aria-hidden="true">31.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <!-- Make the book title only appear if it is *not* the chapter title as well -->
                    <h1 id="book-title" class="menu-title">The DarkFi Book</h1>
                    <script type="text/javascript">
                        var bookTitleElement = document.getElementById('book-title')
                        var bookTitle = 'The DarkFi Book';
                        var chapterTitle = 'P2P Network';
                        if (bookTitle === chapterTitle) {
                            bookTitleElement.innerText = null;
                            document.title = bookTitle;
                        }
                    </script>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="p2p-network"><a class="header" href="#p2p-network">P2P Network</a></h1>
<p>We instantiate a <code>p2p</code> network and call <code>start()</code>. This will begin running a single
p2p network until <code>stop()</code> is called.</p>
<p>There are 3 session types:</p>
<ul>
<li><code>InboundSession</code>, concerned with incoming connections</li>
<li><code>OutboundSession</code>, concerned with outgoing connections</li>
<li><code>SeedSession</code> is a special session type which connects to seed nodes to populate
the hosts pool, then finishes once synced.</li>
</ul>
<p>Connections are made by either <code>Acceptor</code> or <code>Connector</code> for incoming or outgoing
respectively. They have multiple transport types; see <code>src/net/transport/</code> for the
full list.</p>
<p>Connections are then wrapped in a <code>Channel</code> abstraction which allows
protocols to be attached. See <code>src/net/protocol/</code> and run <code>fd protocol</code> for custom
application specific network protocols. Also see the follow tutorial:</p>
<ul>
<li><a href="learn/dchat/creating-dchat/protocols.html">Understanding Protocols</a></li>
</ul>
<h2 id="outbound-session"><a class="header" href="#outbound-session">Outbound Session</a></h2>
<p>The outbound session is responsible to ensure the hosts pool is populated, either
through currently connected nodes or using the seed session.
It performs this algorithm:</p>
<ol>
<li>Start <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> slots, and a sleeping peer discovery process</li>
</ol>
<p>Then each slot performs this algorithm:</p>
<ol>
<li>If no addresses matching our filters are in the hosts pool then:
<ol>
<li>Wakeup the peer discovery process. This does nothing if peer discovery is already active.</li>
<li>Peer discovery tries first 2 times to poll the current network if there are connected nodes,
otherwise it will do a seed server sync.</li>
<li>Peer discovery then wakes any sleeping slots and goes back to sleep.</li>
</ol>
</li>
</ol>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<h3 id="design-considerations"><a class="header" href="#design-considerations">Design Considerations</a></h3>
<ul>
<li>Mitigate attacks to a reasonable degree. Ensuring complete coverage against attacks is infeasible and likely
introduces significant latency into protocols.</li>
<li>Primarily target the p2p network running over anonymity networks like Tor, i2p or Nym.
This means we cannot rely on node addresses being reliable. Even on the clearnet, attackers can easily obtain
large numbers of proxy addresses.</li>
</ul>
<p>The main attacks are:</p>
<ul>
<li><strong>Sybil attack</strong>. A malicious actor tries to subvert the network using sockpuppet nodes. For example
false signalling using version messages on the p2p network.</li>
<li><strong>Eclipse attack</strong>. Targets a single node, through a p2p MitM attack where the malicious actor controls all
the traffic you see. For example they might send you a payment, then want to doublespend without you
knowing about it.</li>
<li><strong>Denial of Service</strong>. Usually happens when a node is overloaded by too much data being sent.</li>
</ul>
<h3 id="common-mitigations"><a class="header" href="#common-mitigations">Common Mitigations</a></h3>
<ul>
<li><strong>Backoff/falloff</strong>. This is the strategy implemented in Bitcoin. This can be bad when arbitrary limits are implemented
since we slow down traffic for no reason.</li>
<li><strong>Choking controller</strong>. BitTorrent no longer uses naive tit-for-tat, instead libtorrent implements an anti-leech seeding algo
from the paper <a href="https://qed.usc.edu/papers/ChowGM08.pdf">Improving BitTorrent: A Simple Approach</a>, which is focused on distributing
bandwidth to all peers. See also <a href="https://github.com/arvidn/libtorrent/blob/RC_2_0/src/choker.cpp">libtorrent/src/choker.cpp</a>.
<ul>
<li>All p2p messages will have a score which represents workload for the node. There is a hard limit, and in general the choker
will try to balance the scores between all available channels.</li>
<li>Opening the connection itself has a score with inbound connections assigned more cost than outgoing ones.</li>
</ul>
</li>
<li><strong>Smart ban</strong>. Malicious peers which violate protocols are hard banned. For example sending the wrong data for a chunk.
<ul>
<li>Add a method <code>channel.ban()</code> which immediately disconnects and blacklists the address.</li>
</ul>
</li>
<li><strong>uTP congestion control</strong>. BitTorrent implements a UDP protocol with its own congestion control. We could do such a similar strategy
with the addition of removing ordering. This reduces protocol latency mitigating attacks. See <a href="https://libtorrent.org/utp.html">libtorrent.org/utp.html</a>
for more info.
<ul>
<li>Maybe less important if we use alternative networks like Tor or i2p.</li>
</ul>
</li>
<li><strong>White, gray and black lists</strong>. See section 2.2 of <a href="https://eprint.iacr.org/2019/411.pdf">Exploring the Monero P2P Network</a> for
details of this algorithm. This aids with network connectivity, avoiding netsplits which could make the network more susceptible to
eclipse/sybil attacks (large scale MiTM).
<ul>
<li>For this we would need a function to connect to a host, send a ping, receive a pong and disconnect to test node connectivity.</li>
</ul>
</li>
<li><strong>Protocol-level reputation system</strong>. You have a keypair, which accrues more trust from the network. Nodes gossip trust metrics.
<ul>
<li>See <a href="https://www.usenix.org/system/files/conference/nsdi16/nsdi16-paper-zhai.pdf">AnonRep: Towards Tracking-Resistant Anonymous Reputation</a></li>
<li>Also the discussion in
<a href="https://ethresear.ch/t/semaphore-rln-rate-limiting-nullifier-for-spam-prevention-in-anonymous-p2p-setting/5009">Semaphore RLN, rate limiting nullifier for spam prevention in anonymous p2p setting</a></li>
</ul>
</li>
<li><strong>Reduce blast radius</strong>. The p2p subsystem should run on its own dedicated executor, separate from database lookups or other
system operations.</li>
<li><strong>fail2ban</strong></li>
<li><strong>Optimized blockchain database</strong>. Most databases are written for interleaved reads and writes as well as deletion. Blockchains follow
a different pattern of infrequent writes being mostly append-only, and requiring weaker guarantees.</li>
</ul>
<h3 id="protocol-suggestions"><a class="header" href="#protocol-suggestions">Protocol Suggestions</a></h3>
<p>Core protocols should be modeled and analyzed with DoS protections added. Below are suggestions to start the investigation.</p>
<ul>
<li>Do not forward orphan txs or blocks.</li>
<li>Drop all double spend txs.
<ul>
<li>Alternatively require a higher fee if we want to enable replace by fee.</li>
<li>Do not forward double spend txs.</li>
</ul>
</li>
<li>Do not forward the same object (block, transaction .etc) to the same peer twice. Violation results in <code>channel.ban()</code>.</li>
<li>Very low fee txs are rate limited.</li>
<li>Limit orphan txs.</li>
<li>Drop large or unusual orphan transactions to limit damage.</li>
<li>Consider a verification cache to prevent attacks that try to trigger re-verification of stored orphan txs. Also limit the size of the cache.
See <a href="https://bitcointalk.org/index.php?topic=136422.0">Fixed vulnerability explanation: Why the signature cache is a DoS protection.</a></li>
<li>Perform more expensive checks later in tx validation.</li>
<li>Nodes will only relay valid transactions with a certain fee amount. More expensive transactions require a higher fee.</li>
<li>Complex operations such as requesting data can be mitigated by tracking the number of requests from a peer.
<ul>
<li>Attackers may attempt flooding invs for invalid data. The peer responds with get data but that object doesn't exist using
up precious bandwidth. Limit both the rate of invs to 2/s and size of items to 35.</li>
<li>Also loops can cause an issue if triggered by the network. This should be carefully analyzed and flattened if possible,
otherwise they should be guarded against attack.</li>
</ul>
</li>
</ul>
<h3 id="customizable-policy"><a class="header" href="#customizable-policy">Customizable Policy</a></h3>
<p>Apps should be able to configure:</p>
<ul>
<li>Reject hosts, for example based off current overall resource utilization or the host addr.</li>
<li>Accounting abstraction for scoring connections.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/tooling.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../arch/services.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/tooling.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../arch/services.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/mermaid-init.js"></script>


    </body>
</html>
